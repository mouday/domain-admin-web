import{_ as S,g as L}from"./index.a3e2cc81.js";import{o as h,c as w,B as z,C as j,al as s,Q as l,I as i,L as r,a as f,M as $,O as y,H as F,P as O,a4 as N,ar as E,J as A,a5 as q}from"./vendor-vue.872ec2a8.js";import{F as J}from"./vendor-lib.5a71f1ae.js";import{R as K,f as W,J as H}from"./jszip.min.2373d893.js";import{C as T}from"./ConnectStatus.e335c2ac.js";import{E as M}from"./ExpireProgress.2a49fd1e.js";import{C as Q,j as X}from"./CodeEditor.7891296e.js";import"./element-plus.39304440.js";import"./element-icon.0ab2c14a.js";import"./DataFormDialog.7b8a4593.js";import"./commonjs-dynamic-modules.cee4dbcc.js";import"./codemirror-lib.49530ef2.js";const Z={domain:[{message:"\u57DF\u540D\u4E0D\u80FD\u4E3A\u7A7A",required:!0,trigger:"blur"}],ssl_certificate:[{message:"\u8BC1\u4E66\u4E0D\u80FD\u4E3A\u7A7A",required:!0,trigger:"blur"}],start_time:[{message:"\u7B7E\u53D1\u65F6\u95F4\u4E0D\u80FD\u4E3A\u7A7A",required:!0,trigger:"blur"}],expire_time:[{message:"\u8FC7\u671F\u65F6\u95F4\u4E0D\u80FD\u4E3A\u7A7A",required:!0,trigger:"blur"}],create_time:[{message:"\u521B\u5EFA\u65F6\u95F4\u4E0D\u80FD\u4E3A\u7A7A",required:!0,trigger:"blur"}]};const G={name:"FileDrop",props:{},components:{},data(){return{uuid:L(),isOver:!1}},computed:{},methods:{dropEvent(t){t.stopPropagation(),t.preventDefault(),this.isOver=!1,this.handleDragLeave(),this.uploadFile(t.dataTransfer.files)},uploadFile(t){this.$emit("on-files",t),this.fileUpload&&this.fileUpload(t)},handleDragEnter(){this.$emit("on-dragenter")},handleDragLeave(){this.$emit("on-dragleave")}},beforeUnmount(){this.$refs.FileDrop.removeEventListener("drop",this.dropEvent,!1)},mounted(){let t=this.$refs.FileDrop;t.addEventListener("drop",this.dropEvent,!1),t.addEventListener("dragleave",e=>{e.stopPropagation(),e.preventDefault(),this.isOver=!1,this.handleDragLeave()}),t.addEventListener("dragenter",e=>{e.stopPropagation(),e.preventDefault(),this.isOver=!0,this.handleDragEnter()}),t.addEventListener("dragover",e=>{e.stopPropagation(),e.preventDefault()})},created(){}};function Y(t,e,o,g,a,n){return h(),w("div",{class:j(["FileDrop",{"FileDrop--active":a.isOver}]),ref:"FileDrop"},[z(t.$slots,"default")],2)}const ee=S(G,[["render",Y]]);const te={name:"",props:{row:{type:Object,default:null}},components:{FileDrop:ee},data(){return{rules:Z,form:{domain:"",ssl_certificate:"",ssl_certificate_key:"",start_time:"",expire_time:"",comment:""}}},computed:{},methods:{async getData(){if(this.row){let t={certificate_id:this.row.certificate_id};const e=await this.$http.getCertificateById(t);if(e.code!=0)return;let o=e.data;this.form.domain=o.domain,this.form.ssl_certificate=o.ssl_certificate,this.form.ssl_certificate_key=o.ssl_certificate_key,this.form.start_time=o.start_time,this.form.expire_time=o.expire_time,this.form.comment=o.comment}},handleCancel(){this.$emit("on-cancel")},handleSubmit(){this.$refs.form.validate(t=>{if(t)this.confirmSubmit();else return!1})},async confirmSubmit(){let t=this.$loading({fullscreen:!0}),e={domain:this.form.domain,ssl_certificate:this.form.ssl_certificate,ssl_certificate_key:this.form.ssl_certificate_key,start_time:this.form.start_time,expire_time:this.form.expire_time,comment:this.form.comment},o=null;this.row?(e.certificate_id=this.row.certificate_id,o=await this.$http.updateCertificateById(e)):o=await this.$http.addCertificate(e),o.code==0?(this.$msg.success("\u64CD\u4F5C\u6210\u529F"),this.$emit("on-success")):this.$msg.error(o.msg),this.$nextTick(()=>{t.close()})},async parsePublicCert(){let t={certificate:this.form.ssl_certificate};const e=await this.$http.parsePublicCert(t);console.log(e),e.ok&&e.data&&(this.form.domain=e.data.subject.CN,this.form.start_time=e.data.notBefore,this.form.expire_time=e.data.notAfter),this.$refs.form.validate()},handleCertificateChange(){!this.form.ssl_certificate||this.parsePublicCert()},handleFileUpload(t,e){if(console.log(t,e),e&&e.length>0){let o=new FileReader;o.readAsText(e[0]),o.onload=g=>{this.form[t]=g.target.result,t=="ssl_certificate"&&this.handleCertificateChange()}}},handleDragenter(t){console.log("handleDragenter",t),this.$refs[t].focus()},handleDragleave(t){console.log("handleDragleave",t),this.$refs[t].blur()}},created(){this.getData()}},le={class:"flex"},oe={class:"text-center"};function ne(t,e,o,g,a,n){const c=s("el-input"),u=s("el-form-item"),m=s("FileDrop"),v=s("el-date-picker"),D=s("el-form"),C=s("el-button");return h(),w("div",null,[l(D,{ref:"form",model:a.form,rules:a.rules,"label-width":"100px"},{default:i(()=>[r(" \u57DF\u540D "),l(u,{label:"\u57DF\u540D",prop:"domain"},{default:i(()=>[l(c,{type:"text",modelValue:a.form.domain,"onUpdate:modelValue":e[0]||(e[0]=p=>a.form.domain=p),placeholder:"\u8BF7\u8F93\u5165\u57DF\u540D"},null,8,["modelValue"])]),_:1}),r(" \u8BC1\u4E66 "),l(u,{label:"\u8BC1\u4E66",prop:"ssl_certificate"},{default:i(()=>[l(m,{onOnFiles:e[2]||(e[2]=p=>n.handleFileUpload("ssl_certificate",p)),onOnDragenter:e[3]||(e[3]=p=>n.handleDragenter("ssl_certificate_input")),onOnDragleave:e[4]||(e[4]=p=>n.handleDragleave("ssl_certificate_input"))},{default:i(()=>[l(c,{ref:"ssl_certificate_input",type:"textarea",modelValue:a.form.ssl_certificate,"onUpdate:modelValue":e[1]||(e[1]=p=>a.form.ssl_certificate=p),placeholder:"\u8BC1\u4E66\u5185\u5BB9\uFF08.pem\u6587\u4EF6\uFF09\uFF0C\u652F\u6301\u62D6\u62FD\u4E0A\u4F20",rows:6,spellcheck:!1,onChange:n.handleCertificateChange},null,8,["modelValue","onChange"])]),_:1})]),_:1}),r(" \u8BC1\u4E66\u79C1\u94A5 "),l(u,{label:"\u8BC1\u4E66\u79C1\u94A5",prop:"ssl_certificate_key"},{default:i(()=>[l(m,{onOnFiles:e[6]||(e[6]=p=>n.handleFileUpload("ssl_certificate_key",p)),onOnDragenter:e[7]||(e[7]=p=>n.handleDragenter("ssl_certificate_key_input")),onOnDragleave:e[8]||(e[8]=p=>n.handleDragleave("ssl_certificate_key_input"))},{default:i(()=>[l(c,{ref:"ssl_certificate_key_input",type:"textarea",modelValue:a.form.ssl_certificate_key,"onUpdate:modelValue":e[5]||(e[5]=p=>a.form.ssl_certificate_key=p),placeholder:"\u8BC1\u4E66\u79C1\u94A5\u5185\u5BB9\uFF08.key\u6587\u4EF6\uFF09\uFF0C\u652F\u6301\u62D6\u62FD\u4E0A\u4F20",rows:6,spellcheck:!1},null,8,["modelValue"])]),_:1})]),_:1}),r(" \u7B7E\u53D1\u65F6\u95F4 "),f("div",le,[l(u,{label:"\u7B7E\u53D1\u65F6\u95F4",prop:"start_time"},{default:i(()=>[l(v,{modelValue:a.form.start_time,"onUpdate:modelValue":e[9]||(e[9]=p=>a.form.start_time=p),type:"date",placeholder:"\u7B7E\u53D1\u65F6\u95F4"},null,8,["modelValue"])]),_:1}),r(" \u8FC7\u671F\u65F6\u95F4 "),l(u,{label:"\u8FC7\u671F\u65F6\u95F4",prop:"expire_time"},{default:i(()=>[l(v,{modelValue:a.form.expire_time,"onUpdate:modelValue":e[10]||(e[10]=p=>a.form.expire_time=p),type:"date",placeholder:"\u8FC7\u671F\u65F6\u95F4"},null,8,["modelValue"])]),_:1})]),r(" \u5907\u6CE8 "),l(u,{label:"\u5907\u6CE8",prop:"comment"},{default:i(()=>[l(c,{type:"textarea",modelValue:a.form.comment,"onUpdate:modelValue":e[11]||(e[11]=p=>a.form.comment=p),placeholder:"\u8BF7\u8F93\u5165\u5907\u6CE8"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"]),r(" \u64CD\u4F5C "),f("div",oe,[l(C,{onClick:n.handleCancel},{default:i(()=>[$(y(t.$t("\u53D6\u6D88")),1)]),_:1},8,["onClick"]),l(C,{type:"primary",onClick:n.handleSubmit},{default:i(()=>[$(y(t.$t("\u786E\u5B9A")),1)]),_:1},8,["onClick"])])])}const ae=S(te,[["render",ne]]),ie={name:"",props:{row:{type:Object,default:null},visible:{type:Boolean,default:!1}},emits:["update:visible"],components:{DataForm:ae},data(){return{}},computed:{dialogTitle(){return this.row?"\u7F16\u8F91\u8BC1\u4E66":"\u6DFB\u52A0\u8BC1\u4E66"},dialogVisible:{get(){return this.visible},set(t){this.$emit("update:visible",t)}}},methods:{handleClose(){this.$emit("update:visible",!1)},handleOpen(){this.$emit("update:visible",!0)},handleSuccess(){this.handleClose(),this.$emit("on-success")}},created(){}};function se(t,e,o,g,a,n){const c=s("DataForm"),u=s("el-dialog");return h(),w(O,null,[r(" \u7F16\u8F91\u6846 "),l(u,{title:n.dialogTitle,modelValue:n.dialogVisible,"onUpdate:modelValue":e[0]||(e[0]=m=>n.dialogVisible=m),width:"800px",center:"",top:"5vh","append-to-body":"","close-on-click-modal":!1},{default:i(()=>[n.dialogVisible?(h(),F(c,{key:0,row:o.row,onOnCancel:n.handleClose,onOnSuccess:n.handleSuccess},null,8,["row","onOnCancel","onOnSuccess"])):r("v-if",!0)]),_:1},8,["title","modelValue"])],2112)}const B=S(ie,[["render",se]]),re={deploy_host:[{message:"\u670D\u52A1\u5668\u5730\u5740\u4E0D\u80FD\u4E3A\u7A7A",required:!0,trigger:"blur"}],deploy_key_file:[{message:"\u79C1\u94A5\u90E8\u7F72\u8DEF\u5F84\u4E0D\u80FD\u4E3A\u7A7A",required:!0,trigger:"blur"}],deploy_fullchain_file:[{message:"\u516C\u94A5\u90E8\u7F72\u8DEF\u5F84\u4E0D\u80FD\u4E3A\u7A7A",required:!0,trigger:"blur"}]},de={name:"",props:{certId:{type:Number,default:null},row:{type:Object,default:null}},components:{RemoteHost:K},data(){return{rules:re,hasInit:!1,host:"",form:{deploy_host_id:"",deploy_host:"",deploy_key_file:"",deploy_fullchain_file:"",deploy_reloadcmd:""},reloadCommandOptions:[]}},computed:{},methods:{async getData(){if(await this.getAllowCommands(),this.row){let t={deploy_cert_id:this.row.deploy_cert_id};const e=await this.$http.getDeployCertById(t);if(e.code!=0)return;let o=e.data;this.form.deploy_host=o.deploy_host,this.form.deploy_key_file=o.deploy_key_file,this.form.deploy_fullchain_file=o.deploy_fullchain_file,this.form.deploy_reloadcmd=o.deploy_reloadcmd}this.hasInit=!0},handleCancel(){this.$emit("on-cancel")},handleSubmit(){this.$refs.form.validate(t=>{if(t)this.confirmSubmit();else return!1})},async confirmSubmit(){let t=this.$loading({fullscreen:!0}),e={cert_id:this.certId,deploy_host_id:this.form.deploy_host.id,deploy_key_file:this.form.deploy_key_file,deploy_fullchain_file:this.form.deploy_fullchain_file,deploy_reloadcmd:this.form.deploy_reloadcmd},o=null;this.row?(e.deploy_cert_id=this.row.deploy_cert_id,o=await this.$http.updateDeployCertById(e)):o=await this.$http.addDeployCert(e),o.code==0?(this.$msg.success("\u64CD\u4F5C\u6210\u529F"),this.$emit("on-success")):this.$msg.error(o.msg),this.$nextTick(()=>{t.close()})},async getAllowCommands(){const t=await this.$http.getAllowCommands();t.ok&&(this.reloadCommandOptions=t.data.map(e=>({value:e,label:e})),this.form.deploy_reloadcmd||(this.form.deploy_reloadcmd=this.reloadCommandOptions[0].value))}},created(){this.getData()}},ce={class:"flex"},pe={class:"ml-sm text-sm color--info flex items-center"},ue={class:"text-center"};function me(t,e,o,g,a,n){const c=s("RemoteHost"),u=s("el-form-item"),m=s("el-input"),v=s("el-option"),D=s("el-select"),C=s("Warning"),p=s("el-icon"),k=s("el-form"),V=s("el-button");return h(),w("div",null,[l(k,{ref:"form",model:a.form,rules:a.rules,"label-width":"120px"},{default:i(()=>[r(" \u670D\u52A1\u5668\u5730\u5740 "),l(u,{label:"\u670D\u52A1\u5668\u5730\u5740",prop:"deploy_host"},{default:i(()=>[a.hasInit?(h(),F(c,{key:0,defaultKeyword:a.host,modelValue:a.form.deploy_host,"onUpdate:modelValue":e[0]||(e[0]=_=>a.form.deploy_host=_)},null,8,["defaultKeyword","modelValue"])):r("v-if",!0)]),_:1}),r(" \u79C1\u94A5\u90E8\u7F72\u8DEF\u5F84 "),l(u,{label:"\u79C1\u94A5\u90E8\u7F72\u8DEF\u5F84",prop:"deploy_key_file"},{default:i(()=>[l(m,{type:"text",modelValue:a.form.deploy_key_file,"onUpdate:modelValue":e[1]||(e[1]=_=>a.form.deploy_key_file=_),placeholder:"\u8BF7\u8F93\u5165\u79C1\u94A5\u90E8\u7F72\u7684\u7EDD\u5BF9\u8DEF\u5F84\uFF0Ceg: /usr/ssl/xxx.key"},null,8,["modelValue"])]),_:1}),r(" \u516C\u94A5\u90E8\u7F72\u8DEF\u5F84 "),l(u,{label:"\u516C\u94A5\u90E8\u7F72\u8DEF\u5F84",prop:"deploy_fullchain_file"},{default:i(()=>[l(m,{type:"text",modelValue:a.form.deploy_fullchain_file,"onUpdate:modelValue":e[2]||(e[2]=_=>a.form.deploy_fullchain_file=_),placeholder:"\u8BF7\u8F93\u5165\u516C\u94A5\u90E8\u7F72\u7684\u7EDD\u5BF9\u8DEF\u5F84\uFF0Ceg: /usr/ssl/xxx.pem"},null,8,["modelValue"])]),_:1}),r(" \u91CD\u542F\u547D\u4EE4 "),l(u,{label:"\u91CD\u542F\u547D\u4EE4",prop:"deploy_reloadcmd"},{default:i(()=>[f("div",ce,[l(D,{style:{width:"300px"},modelValue:a.form.deploy_reloadcmd,"onUpdate:modelValue":e[3]||(e[3]=_=>a.form.deploy_reloadcmd=_),placeholder:t.$t("\u91CD\u542F\u547D\u4EE4")},{default:i(()=>[(h(!0),w(O,null,N(a.reloadCommandOptions,_=>(h(),F(v,{key:_.value,label:_.label,value:_.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"]),f("div",pe,[l(p,null,{default:i(()=>[l(C)]),_:1}),e[4]||(e[4]=f("a",{class:"mo-link",style:{"margin-left":"4px"},href:"https://domain-admin.readthedocs.io/zh-cn/latest/manual/install.html#id7",target:"_blank"},"\u5982\u4F55\u8BBE\u7F6E\u547D\u4EE4\uFF1F",-1))])])]),_:1})]),_:1},8,["model","rules"]),r(" \u64CD\u4F5C "),f("div",ue,[l(V,{onClick:n.handleCancel},{default:i(()=>[$(y(t.$t("\u53D6\u6D88")),1)]),_:1},8,["onClick"]),l(V,{type:"primary",onClick:n.handleSubmit},{default:i(()=>[$(y(t.$t("\u786E\u5B9A")),1)]),_:1},8,["onClick"])])])}const _e=S(de,[["render",me]]),he={name:"",props:{certId:{type:Number,default:null},row:{type:Object,default:null},visible:{type:Boolean,default:!1}},emits:["update:visible"],components:{DataForm:_e},data(){return{}},computed:{dialogTitle(){return this.row?"\u7F16\u8F91":"\u6DFB\u52A0"},dialogVisible:{get(){return this.visible},set(t){this.$emit("update:visible",t)}}},methods:{handleClose(){this.$emit("update:visible",!1)},handleOpen(){this.$emit("update:visible",!0)},handleSuccess(){this.handleClose(),this.$emit("on-success")}},created(){}};function fe(t,e,o,g,a,n){const c=s("DataForm"),u=s("el-dialog");return h(),w(O,null,[r(" \u7F16\u8F91\u6846 "),l(u,{title:n.dialogTitle,modelValue:n.dialogVisible,"onUpdate:modelValue":e[0]||(e[0]=m=>n.dialogVisible=m),width:"600px",center:"","append-to-body":""},{default:i(()=>[n.dialogVisible?(h(),F(c,{key:0,certId:o.certId,row:o.row,onOnCancel:n.handleClose,onOnSuccess:n.handleSuccess},null,8,["certId","row","onOnCancel","onOnSuccess"])):r("v-if",!0)]),_:1},8,["title","modelValue"])],2112)}const P=S(he,[["render",fe]]),ge={name:"",components:{DataFormDialog:P,ConnectStatus:T},props:{list:{type:Array},certId:{type:Number,default:null}},computed:{},data(){return{currentRow:null,dialogVisible:!1}},methods:{handleEditRow(t){this.currentRow=t,this.dialogVisible=!0},async handleDeleteClick(t){let e={deploy_cert_id:t.deploy_cert_id};const o=await this.$http.deleteByDeployCertId(e);o.code==0?(this.$msg.success("\u64CD\u4F5C\u6210\u529F"),this.$emit("on-success")):this.$msg.error(o.msg)},async handleStatusChange(t){let e={id:t.id};const o=await this.$http.function(e);o.code==0?(this.$msg.success("\u64CD\u4F5C\u6210\u529F"),this.$emit("on-success")):this.$msg.error(o.msg)},handleUpdateSuccess(){this.$emit("on-success")},handleDeployRow(t){this.$emit("on-deploy",t)}},created(){}};function ye(t,e,o,g,a,n){const c=s("el-table-column"),u=s("ConnectStatus"),m=s("el-tooltip"),v=s("Position"),D=s("el-icon"),C=s("el-link"),p=s("el-popconfirm"),k=s("Edit"),V=s("Delete"),_=s("el-table"),I=s("DataFormDialog");return h(),w("div",null,[l(_,{data:o.list,stripe:"",border:"",onSelectionChange:e[0]||(e[0]=b=>t.$emit("on-selection-change",b))},{default:i(()=>[r(` <el-table-column
        label="ID"
        align="center"
        prop="id"
        width="60"
      >
        <template #default="scope">
          <span>{{ scope.row.id || '-' }}</span>
        </template>
      </el-table-column> `),l(c,{type:"selection","header-align":"center",align:"center",width:"40"}),r(" \u670D\u52A1\u5668\u5730\u5740 "),l(c,{label:"\u670D\u52A1\u5668\u5730\u5740","header-align":"center",align:"center",width:"140",prop:"deploy_host_id"},{default:i(b=>{var x;return[f("span",null,y(((x=b.row.deploy_host)==null?void 0:x.host)||"-"),1)]}),_:1}),r(" \u79C1\u94A5\u90E8\u7F72\u8DEF\u5F84 "),l(c,{label:"\u79C1\u94A5\u90E8\u7F72\u8DEF\u5F84","header-align":"center",align:"center",prop:"deploy_key_file"},{default:i(b=>[f("span",null,y(b.row.deploy_key_file||"-"),1)]),_:1}),r(" \u516C\u94A5\u90E8\u7F72\u8DEF\u5F84 "),l(c,{label:"\u516C\u94A5\u90E8\u7F72\u8DEF\u5F84","header-align":"center",align:"center",prop:"deploy_fullchain_file"},{default:i(b=>[f("span",null,y(b.row.deploy_fullchain_file||"-"),1)]),_:1}),r(" \u91CD\u542F\u547D\u4EE4 "),l(c,{label:"\u91CD\u542F\u547D\u4EE4","header-align":"center",align:"center",prop:"deploy_reloadcmd"},{default:i(b=>[f("span",null,y(b.row.deploy_reloadcmd||"-"),1)]),_:1}),r(" \u64CD\u4F5C "),l(c,{label:"\u72B6\u6001","header-align":"center",align:"center",width:"80"},{default:i(b=>[l(m,{effect:"dark",placement:"top",content:b.row.deploy_status_label},{default:i(()=>[l(u,{value:b.row.deploy_status},null,8,["value"])]),_:2},1032,["content"])]),_:1}),l(c,{label:"\u64CD\u4F5C",width:"100","header-align":"center",align:"center"},{default:i(b=>[l(p,{title:`${t.$t("\u786E\u5B9A\u90E8\u7F72")}\uFF1F`,onConfirm:x=>n.handleDeployRow(b.row)},{reference:i(()=>[l(C,{underline:!1,type:"primary",class:"mr-sm"},{default:i(()=>[l(D,null,{default:i(()=>[l(v)]),_:1})]),_:1})]),_:2},1032,["title","onConfirm"]),l(C,{underline:!1,type:"primary",class:"mr-sm",onClick:x=>n.handleEditRow(b.row)},{default:i(()=>[l(D,null,{default:i(()=>[l(k)]),_:1})]),_:2},1032,["onClick"]),l(p,{title:`${t.$t("\u786E\u5B9A\u5220\u9664")}\uFF1F`,onConfirm:x=>n.handleDeleteClick(b.row)},{reference:i(()=>[l(C,{underline:!1,type:"danger"},{default:i(()=>[l(D,null,{default:i(()=>[l(V)]),_:1})]),_:1})]),_:2},1032,["title","onConfirm"])]),_:1})]),_:1},8,["data"]),r(" \u7F16\u8F91\u6846 "),l(I,{visible:a.dialogVisible,"onUpdate:visible":e[1]||(e[1]=b=>a.dialogVisible=b),certId:o.certId,row:a.currentRow,onOnSuccess:n.handleUpdateSuccess},null,8,["visible","certId","row","onOnSuccess"])])}const be=S(ge,[["render",ye]]),we={name:"deploy-cert-list",props:{certId:{type:Number,default:null}},components:{DataFormDialog:P,DataTable:be},data(){return{selectedRows:[],list:[],total:0,page:1,size:20,keyword:"",loading:!0,dialogVisible:!1}},computed:{},methods:{resetData(){this.page=1,this.getData()},handleRow(t){return t.status==1?(t.deploy_status=!0,t.deploy_status_label="\u90E8\u7F72\u6210\u529F"):t.status==2?(t.deploy_status=!1,t.deploy_status_label="\u90E8\u7F72\u5931\u8D25"):(t.deploy_status=null,t.deploy_status_label="\u672A\u90E8\u7F72"),t},async getData(){this.loading=!0;let t={cert_id:this.certId,page:this.page,size:this.size,keyword:this.keyword};try{const e=await this.$http.getDeployListByCertId(t);e.code==0&&(this.list=e.data.list.map(o=>this.handleRow(o)),this.total=e.data.total)}catch(e){console.log(e)}finally{this.loading=!1}},async getDeployCertById(t){let e={deploy_cert_id:t};const o=await this.$http.getDeployCertById(e);o.ok&&(this.list=this.list.map(g=>g.deploy_cert_id==t?this.handleRow(o.data):g))},handleAddRow(){this.dialogVisible=!0},handleAddSuccess(){this.resetData()},handleSearch(){this.resetData()},handleDeployAll(){},async handleDeployRow(t){let e={deploy_cert_id:t.deploy_cert_id};const o=await this.$http.handleDeployCert(e);return await this.getDeployCertById(t.deploy_cert_id),o},async handleDeployOneRow(t){let e=this.$loading({fullscreen:!0});const o=await this.handleDeployRow(t);o.ok?this.$msg.success("\u90E8\u7F72\u5B8C\u6210"):this.$msg.error(o.msg),this.$nextTick(()=>{e.close()})},async handleDeployAllRow(){let t=this.$loading({fullscreen:!0}),e=0,o=this.selectedRows.length;for(let g of this.selectedRows)e++,t.setText(`\u90E8\u7F72\u4E2D\uFF1A${e} / ${o}`),await this.handleDeployRow(g);this.$msg.success("\u90E8\u7F72\u5B8C\u6210"),this.$nextTick(()=>{t.close()})},handleSelectionChange(t){this.selectedRows=t,console.log(t)},handleEditRow(t){}},created(){this.getData()}},De={class:""},Ce={class:"flex justify-between"};function ve(t,e,o,g,a,n){const c=s("Plus"),u=s("el-icon"),m=s("el-button"),v=s("Position"),D=s("el-popconfirm"),C=s("DataTable"),p=s("el-pagination"),k=s("DataFormDialog"),V=E("loading");return h(),w("div",De,[r(" \u64CD\u4F5C\u6309\u94AE "),f("div",Ce,[l(m,{type:"primary",onClick:n.handleAddRow},{default:i(()=>[l(u,null,{default:i(()=>[l(c)]),_:1}),$(y(t.$t("\u6DFB\u52A0")),1)]),_:1},8,["onClick"]),r(` <el-input
        class="ml-sm"
        style="width: 260px"
        v-model="keyword"
        placeholder="\u8F93\u5165\u670D\u52A1\u5668\u5730\u5740"
        clearable
        @keypress.enter="handleSearch"
        @clear="handleSearch"
      >
        <template #append>
          <el-button @click="handleSearch">
            <el-icon><Search /></el-icon
          ></el-button>
        </template>
      </el-input> `),l(D,{title:`${t.$t("\u786E\u5B9A\u90E8\u7F72")}\uFF1F`,onConfirm:n.handleDeployAllRow},{reference:i(()=>[l(m,{disabled:a.selectedRows.length==0},{default:i(()=>[l(u,null,{default:i(()=>[l(v)]),_:1}),$(y(t.$t("\u4E00\u952E\u90E8\u7F72")),1)]),_:1},8,["disabled"])]),_:1},8,["title","onConfirm"])]),r(" \u6570\u636E\u5217\u8868 "),A(l(C,{class:"mt-md",list:a.list,certId:o.certId,onOnSuccess:n.resetData,onOnEditRow:n.handleEditRow,onOnDeploy:n.handleDeployOneRow,onOnSelectionChange:n.handleSelectionChange},null,8,["list","certId","onOnSuccess","onOnEditRow","onOnDeploy","onOnSelectionChange"]),[[V,a.loading]]),r(" \u7FFB\u9875 "),l(p,{class:"mt-md justify-center",background:"",layout:"total, prev, pager, next",total:a.total,"page-size":a.size,"onUpdate:pageSize":e[0]||(e[0]=_=>a.size=_),"current-page":a.page,"onUpdate:currentPage":e[1]||(e[1]=_=>a.page=_),onCurrentChange:n.getData},null,8,["total","page-size","current-page","onCurrentChange"]),r(" \u7F16\u8F91\u6846 "),l(k,{visible:a.dialogVisible,"onUpdate:visible":e[2]||(e[2]=_=>a.dialogVisible=_),certId:o.certId,onOnSuccess:n.handleAddSuccess},null,8,["visible","certId","onOnSuccess"])])}const ke=S(we,[["render",ve]]),Se={name:"",props:{certId:{type:Number,default:null},row:{type:Object,default:null},visible:{type:Boolean,default:!1}},components:{DataTableIndex:ke},data(){return{}},computed:{dialogTitle(){return this.row?"\u7F16\u8F91":"\u6DFB\u52A0"},dialogVisible:{get(){return this.visible},set(t){this.$emit("update:visible",t)}}},methods:{handleClose(){this.$emit("on-close")},handleCancel(){this.dialogVisible=!1},handleOpen(){this.dialogVisible=!0},handleSuccess(){this.handleClose(),this.$emit("on-success")}},created(){}};function Ve(t,e,o,g,a,n){const c=s("DataTableIndex"),u=s("el-dialog");return h(),w(O,null,[r(" \u7F16\u8F91\u6846 "),l(u,{title:n.dialogTitle,modelValue:n.dialogVisible,"onUpdate:modelValue":e[0]||(e[0]=m=>n.dialogVisible=m),width:"1200px",center:"","append-to-body":"",onClose:n.handleClose},{default:i(()=>[n.dialogVisible?(h(),F(c,{key:0,certId:o.certId,row:o.row,onOnCancel:n.handleCancel,onOnSuccess:n.handleSuccess},null,8,["certId","row","onOnCancel","onOnSuccess"])):r("v-if",!0)]),_:1},8,["title","modelValue","onClose"])],2112)}const Oe=S(Se,[["render",Ve]]),xe={name:"DownloadStepByAPI",props:{certId:{type:String},form:{type:Object},issueCertificate:{type:Object}},emits:["on-success","on-close"],components:{CodeEditor:Q},data(){return{deployForm:{url:"",headers:""},rules:{url:[{message:"\u8FDC\u7A0BURL\u4E0D\u80FD\u4E3A\u7A7A",required:!0,trigger:"blur"}],headers:[{validator:X,trigger:"blur"}]},headerExample:JSON.stringify({"X-Token":"TOKEN"},null,4)}},computed:{},methods:{async getData(){const t={certificate_id:this.certId},e=await this.$http.getDeployWebhook(t);e.ok&&e.data&&(this.deployForm.url=e.data.url,this.deployForm.headers=e.data.headers?JSON.stringify(e.data.headers,null,4):this.headerExample)},handleClose(){this.$emit("on-close")},async handleDeploy(t){this.$refs.form.validate(e=>{if(e)this.confirmSubmit(t);else return!1})},async confirmSubmit(){let t=this.$loading({fullscreen:!0}),e={certificate_id:this.certId,headers:this.deployForm.headers?JSON.parse(this.deployForm.headers):null,url:this.deployForm.url};const o=await this.$http.deployCertificateByWebhook(e);o.ok?this.$msg.success("\u64CD\u4F5C\u6210\u529F\uFF1A"+o.data.result):this.$msg.error(o.msg),this.$nextTick(()=>{t.close()}),this.$emit("on-submit")}},created(){this.getData()}},$e={class:"flex flex-1"},Fe={class:"ml-sm text-sm mo-link flex items-center justify-end",href:"https://domain-admin.readthedocs.io/zh-cn/latest/manual/ssl-cert.html#id4",target:"_blank"};function Re(t,e,o,g,a,n){const c=s("el-input"),u=s("el-button"),m=s("Warning"),v=s("el-icon"),D=s("el-form-item"),C=s("CodeEditor"),p=s("el-form");return h(),w("div",null,[l(p,{ref:"form",model:a.deployForm,rules:a.rules,"label-width":"80px"},{default:i(()=>[l(D,{label:t.$t("\u8FDC\u7A0BURL"),prop:"url"},{default:i(()=>[f("div",$e,[l(c,{class:"flex-1",modelValue:a.deployForm.url,"onUpdate:modelValue":e[0]||(e[0]=k=>a.deployForm.url=k)},null,8,["modelValue"]),l(u,{class:"ml-sm",type:"primary",onClick:n.handleDeploy},{default:i(()=>e[2]||(e[2]=[$("\u90E8\u7F72",-1)])),_:1,__:[2]},8,["onClick"]),f("a",Fe,[l(v,null,{default:i(()=>[l(m)]),_:1}),e[3]||(e[3]=f("span",null,"\xA0\u67E5\u770B\u63A5\u53E3\u6587\u6863",-1))])])]),_:1},8,["label"]),l(D,{label:t.$t("\u8BF7\u6C42\u5934"),prop:"headers"},{default:i(()=>[l(C,{modelValue:a.deployForm.headers,"onUpdate:modelValue":e[1]||(e[1]=k=>a.deployForm.headers=k),height:"200px",placeholder:`\u793A\u4F8B: 
${a.headerExample}`},null,8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1},8,["model","rules"])])}const Ie=S(xe,[["render",Re]]),Ue={name:"",props:{certId:{type:Number,default:null},row:{type:Object,default:null},visible:{type:Boolean,default:!1}},emits:["update:visible"],components:{DataForm:Ie},data(){return{}},computed:{dialogTitle(){return this.row?"\u7F16\u8F91":"\u6DFB\u52A0"},dialogVisible:{get(){return this.visible},set(t){this.$emit("update:visible",t)}}},methods:{handleClose(){this.$emit("on-close")},handleCancel(){this.$emit("update:visible",!1)},handleOpen(){this.$emit("update:visible",!0)},handleSuccess(){this.handleCancel(),this.$emit("on-success")}},created(){}};function Ee(t,e,o,g,a,n){const c=s("DataForm"),u=s("el-dialog");return h(),w(O,null,[r(" \u7F16\u8F91\u6846 "),l(u,{title:"API\u90E8\u7F72",modelValue:n.dialogVisible,"onUpdate:modelValue":e[0]||(e[0]=m=>n.dialogVisible=m),width:"600px",center:"","append-to-body":"",onClose:n.handleClose},{default:i(()=>[n.dialogVisible?(h(),F(c,{key:0,certId:o.certId,row:o.row,onOnCancel:n.handleCancel,onOnSuccess:n.handleSuccess},null,8,["certId","row","onOnCancel","onOnSuccess"])):r("v-if",!0)]),_:1},8,["modelValue","onClose"])],2112)}const Ae=S(Ue,[["render",Ee]]),Te={name:"",components:{DataFormDialog:B,ConnectStatus:T,ExpireProgress:M,DeployCertListDialog:Oe,DeployApiFormDialog:Ae},props:{list:{type:Array}},computed:{},data(){return{currentRow:null,dialogVisible:!1,deployCertListDialogVisible:!1,deployByApiDialogVisible:!1}},methods:{handleEditRow(t){this.currentRow=t,this.dialogVisible=!0},async handleDeleteClick(t){let e={certificate_id:t.certificate_id};const o=await this.$http.deleteCertificateById(e);o.code==0?(this.$msg.success("\u64CD\u4F5C\u6210\u529F"),this.$emit("on-success")):this.$msg.error(o.msg)},async handleStatusChange(t){let e={id:t.id};const o=await this.$http.function(e);o.code==0?(this.$msg.success("\u64CD\u4F5C\u6210\u529F"),this.$emit("on-success")):this.$msg.error(o.msg)},handleUpdateSuccess(){this.$emit("on-success")},async downloadSSLFile(t){let e=W(t.domain);const o=new H;o.file(`${e}.pem`,t.ssl_certificate),o.file(`${e}.key`,t.ssl_certificate_key),o.generateAsync({type:"blob"}).then(function(g){J.saveAs(g,`${e}.zip`)})},handleDeployCountClick(t){this.currentRow=t,this.deployCertListDialogVisible=!0},handleDeployApiClick(t){this.currentRow=t,this.deployByApiDialogVisible=!0},handleDialogClose(){this.$emit("on-row-update",this.currentRow)}},created(){}},Be={key:0,class:"color--danger"},Pe={class:"color--warning"},Le={class:"color--success"},ze={class:"color--info"},je={key:0,class:"color--danger"};function Ne(t,e,o,g,a,n){var x,U;const c=s("el-table-column"),u=s("ExpireProgress"),m=s("el-link"),v=s("Download"),D=s("el-icon"),C=s("Edit"),p=s("Delete"),k=s("el-popconfirm"),V=s("el-table"),_=s("DataFormDialog"),I=s("DeployCertListDialog"),b=s("DeployApiFormDialog");return h(),w("div",null,[l(V,{data:o.list,stripe:"",border:"",onSortChange:e[0]||(e[0]=d=>t.$emit("on-sort-change",d))},{default:i(()=>[r(" \u57DF\u540D "),l(c,{label:"\u57DF\u540D","header-align":"center",align:"center",prop:"domain"},{default:i(d=>[f("span",null,y(d.row.domain||"-"),1)]),_:1}),r(" \u8BC1\u4E66\u5929\u6570 "),l(c,{label:t.$t("\u8BC1\u4E66\u5929\u6570"),"header-align":"center",align:"center",width:"110",sortable:"custom",prop:"expire_time"},{default:i(d=>[l(u,{startTime:d.row.start_time,endTime:d.row.expire_time},null,8,["startTime","endTime"])]),_:1},8,["label"]),r(" \u7B7E\u53D1\u65F6\u95F4 "),l(c,{label:"\u7B7E\u53D1\u65F6\u95F4","header-align":"center",align:"center",prop:"start_time",width:"120"},{default:i(d=>[f("span",null,y(d.row.start_date||"-"),1)]),_:1}),r(" \u8FC7\u671F\u65F6\u95F4 "),l(c,{label:"\u8FC7\u671F\u65F6\u95F4","header-align":"center",align:"center",prop:"expire_time",width:"120"},{default:i(d=>[f("span",null,y(d.row.expire_date||"-"),1)]),_:1}),r(" \u5907\u6CE8 "),l(c,{label:"\u5907\u6CE8","header-align":"center",align:"center",prop:"comment"},{default:i(d=>[f("span",null,y(d.row.comment||"-"),1)]),_:1}),r(" \u521B\u5EFA\u65F6\u95F4 "),l(c,{label:"\u521B\u5EFA\u65F6\u95F4","header-align":"center",align:"center",prop:"create_time",width:"120"},{default:i(d=>[f("span",null,y(d.row.create_time_label||"-"),1)]),_:1}),r(" \u90E8\u7F72 "),l(c,{label:"SSH\u90E8\u7F72","header-align":"center",align:"center",prop:"create_time",width:"100"},{default:i(d=>[l(m,{underline:!1,type:"primary",onClick:R=>n.handleDeployCountClick(d.row)},{default:i(()=>[r(" \u6709\u5931\u8D25 "),d.row.deploy_error_count>0?(h(),w("span",Be,y(d.row.deploy_success_count)+"/"+y(d.row.deploy_count),1)):d.row.deploy_pending_count>0?(h(),w(O,{key:1},[r(" \u6709\u5F02\u5E38 "),f("span",Pe,y(d.row.deploy_success_count)+"/"+y(d.row.deploy_count),1)],2112)):d.row.deploy_count>0?(h(),w(O,{key:2},[r(" \u90FD\u6210\u529F "),f("span",Le,y(d.row.deploy_count),1)],2112)):(h(),w(O,{key:3},[r(" \u6CA1\u6709\u90E8\u7F72 "),f("span",ze,y(d.row.deploy_count),1)],2112))]),_:2},1032,["onClick"])]),_:1}),r(" \u90E8\u7F72 "),l(c,{label:"API\u90E8\u7F72","header-align":"center",align:"center",prop:"create_time",width:"100"},{default:i(d=>[l(m,{underline:!1,type:"primary",onClick:R=>n.handleDeployApiClick(d.row)},{default:i(()=>[r(" \u6709\u5931\u8D25 "),d.row.api_deploy_status===2?(h(),w("span",je," \u90E8\u7F72\u5931\u8D25 ")):d.row.api_deploy_status===1?(h(),w(O,{key:1},[r(" \u6210\u529F "),e[4]||(e[4]=f("span",{class:"color--success"},"\u90E8\u7F72\u6210\u529F",-1))],2112)):(h(),w(O,{key:2},[r(" \u6CA1\u6709\u90E8\u7F72 "),e[5]||(e[5]=f("span",{class:"color--info"}," \u672A\u90E8\u7F72",-1))],2112))]),_:2},1032,["onClick"])]),_:1}),r(" \u64CD\u4F5C "),r(` <el-table-column
        label="\u72B6\u6001"
        header-align="center"
        align="center"
        width="80"
      >
        <template #default="scope">
          <el-switch
            v-model="scope.row.status"
            @change="handleStatusChange(scope.row, $event)"
          />
        </template>
      </el-table-column> `),r(" \u8BC1\u4E66 "),l(c,{label:"\u8BC1\u4E66","header-align":"center",align:"center",prop:"ssl_certificate",width:"60"},{default:i(d=>[l(m,{underline:!1,type:"primary",onClick:R=>n.downloadSSLFile(d.row)},{default:i(()=>[l(D,null,{default:i(()=>[l(v)]),_:1})]),_:2},1032,["onClick"])]),_:1}),l(c,{label:"\u64CD\u4F5C",width:"80","header-align":"center",align:"center"},{default:i(d=>[l(m,{underline:!1,type:"primary",class:"mr-sm",onClick:R=>n.handleEditRow(d.row)},{default:i(()=>[l(D,null,{default:i(()=>[l(C)]),_:1})]),_:2},1032,["onClick"]),l(k,{title:`${t.$t("\u786E\u5B9A\u5220\u9664")}\uFF1F`,onConfirm:R=>n.handleDeleteClick(d.row)},{reference:i(()=>[l(m,{underline:!1,type:"danger"},{default:i(()=>[l(D,null,{default:i(()=>[l(p)]),_:1})]),_:1})]),_:2},1032,["title","onConfirm"])]),_:1})]),_:1},8,["data"]),r(" \u7F16\u8F91\u6846 "),l(_,{visible:a.dialogVisible,"onUpdate:visible":e[1]||(e[1]=d=>a.dialogVisible=d),row:a.currentRow,onOnSuccess:n.handleUpdateSuccess},null,8,["visible","row","onOnSuccess"]),r(" \u8BC1\u4E66\u90E8\u7F72\u5217\u8868 "),l(I,{visible:a.deployCertListDialogVisible,"onUpdate:visible":e[2]||(e[2]=d=>a.deployCertListDialogVisible=d),certId:(x=a.currentRow)==null?void 0:x.certificate_id,onOnSuccess:n.handleUpdateSuccess,onOnClose:n.handleDialogClose},null,8,["visible","certId","onOnSuccess","onOnClose"]),r(" \u8BC1\u4E66api\u90E8\u7F72\u5217\u8868 "),l(b,{visible:a.deployByApiDialogVisible,"onUpdate:visible":e[3]||(e[3]=d=>a.deployByApiDialogVisible=d),certId:(U=a.currentRow)==null?void 0:U.certificate_id,onOnSuccess:n.handleUpdateSuccess,onOnClose:n.handleDialogClose},null,8,["visible","certId","onOnSuccess","onOnClose"])])}const qe=S(Te,[["render",Ne]]),Je={name:"certificate-list",props:{},components:{DataFormDialog:B,DataTable:qe},data(){return{list:[],total:0,page:1,size:20,keyword:"",order_type:"",order_prop:"",loading:!0,dialogVisible:!1}},computed:{},methods:{resetData(){this.page=1,this.getData()},async getData(){this.loading=!0;let t={page:this.page,size:this.size,keyword:this.keyword,order_type:this.order_type,order_prop:this.order_prop};try{const e=await this.$http.getCertificateList(t);e.code==0&&(this.list=e.data.list,this.total=e.data.total)}catch(e){console.log(e)}finally{this.loading=!1}},handleAddRow(){this.dialogVisible=!0},handleAddSuccess(){this.resetData()},handleSearch(){this.resetData()},handleEditRow(t){},async handleRowUpdated(t){let e={certificate_id:t.certificate_id};const o=await this.$http.getCertificateById(e);o.ok&&(this.list=this.list.map(g=>g.certificate_id==o.data.certificate_id?o.data:g))},handleSortChange({column:t,prop:e,order:o}){console.log(t,e,o),this.order_prop="",this.order_type="",o&&(this.order_type=o=="descending"?"desc":"asc",this.order_prop=e),this.resetData()}},created(){this.getData()}},Ke={class:"app-container"},We={class:"flex justify-between"};function He(t,e,o,g,a,n){const c=s("Plus"),u=s("el-icon"),m=s("el-button"),v=s("Search"),D=s("el-input"),C=s("DataTable"),p=s("el-pagination"),k=s("DataFormDialog"),V=E("loading");return h(),w("div",Ke,[r(" \u64CD\u4F5C\u6309\u94AE "),f("div",We,[l(m,{type:"primary",onClick:n.handleAddRow},{default:i(()=>[l(u,null,{default:i(()=>[l(c)]),_:1}),$(y(t.$t("\u6DFB\u52A0")),1)]),_:1},8,["onClick"]),l(D,{class:"ml-sm",style:{width:"260px"},modelValue:a.keyword,"onUpdate:modelValue":e[0]||(e[0]=_=>a.keyword=_),placeholder:"\u8F93\u5165\u57DF\u540D",clearable:"",onKeypress:q(n.handleSearch,["enter"]),onClear:n.handleSearch},{append:i(()=>[l(m,{onClick:n.handleSearch},{default:i(()=>[l(u,null,{default:i(()=>[l(v)]),_:1})]),_:1},8,["onClick"])]),_:1},8,["modelValue","onKeypress","onClear"])]),r(" \u6570\u636E\u5217\u8868 "),A(l(C,{class:"mt-md",list:a.list,onOnSuccess:n.resetData,onOnEditRow:n.handleEditRow,onOnRowUpdate:n.handleRowUpdated,onOnSortChange:n.handleSortChange},null,8,["list","onOnSuccess","onOnEditRow","onOnRowUpdate","onOnSortChange"]),[[V,a.loading]]),r(" \u7FFB\u9875 "),l(p,{class:"mt-md justify-center",background:"",layout:"total, prev, pager, next",total:a.total,"page-size":a.size,"onUpdate:pageSize":e[1]||(e[1]=_=>a.size=_),"current-page":a.page,"onUpdate:currentPage":e[2]||(e[2]=_=>a.page=_),onCurrentChange:n.getData},null,8,["total","page-size","current-page","onCurrentChange"]),r(" \u7F16\u8F91\u6846 "),l(k,{visible:a.dialogVisible,"onUpdate:visible":e[3]||(e[3]=_=>a.dialogVisible=_),onOnSuccess:n.handleAddSuccess},null,8,["visible","onOnSuccess"])])}const it=S(Je,[["render",He]]);export{it as default};
